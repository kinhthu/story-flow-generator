<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Story Flow Generator</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .steps-container {
      padding: 30px;
    }

    .step {
      margin-bottom: 40px;
      border: 2px solid #e1e5e9;
      border-radius: 15px;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .step.active {
      border-color: #667eea;
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
    }

    .step-header {
      background: #f8f9fa;
      padding: 20px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.3s ease;
    }

    .step-header:hover {
      background: #e9ecef;
    }

    .step-header h3 {
      font-size: 1.3rem;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .step-number {
      background: #667eea;
      color: white;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .step-content {
      padding: 30px;
      display: none;
    }

    .step.active .step-content {
      display: block;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    .form-control:focus {
      outline: none;
      border-color: #667eea;
    }

    .character-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 15px;
      margin-top: 10px;
    }

    .character-card {
      border: 2px solid #e1e5e9;
      border-radius: 15px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
      display: flex;
      align-items: center;
      gap: 15px;
      min-height: 100px;
    }

    .character-card:hover {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
    }

    .character-card.selected {
      border-color: #667eea;
      background: #f0f4ff;
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
    }

    .character-image {
      flex-shrink: 0;
      width: 80px;
      height: 80px;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid #e1e5e9;
      background: #f8f9fa;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .character-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
      background: #f8f9fa;
    }

    .character-image img.loading {
      opacity: 0.7;
      animation: imagePulse 1.5s ease-in-out infinite;
    }

    .character-image img.error {
      opacity: 0.5;
    }

    @keyframes imagePulse {

      0%,
      100% {
        opacity: 0.7;
      }

      50% {
        opacity: 0.4;
      }
    }

    .character-card:hover .character-image img {
      transform: scale(1.05);
    }

    .character-info {
      flex: 1;
      min-width: 0;
    }

    .character-card h4 {
      margin-bottom: 8px;
      color: #333;
      font-size: 1.1rem;
      font-weight: 600;
    }

    .character-card p {
      font-size: 0.85rem;
      color: #666;
      line-height: 1.4;
      margin: 0;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, .3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .results-container {
      margin-top: 20px;
    }

    .idea-card,
    .story-card,
    .scene-card {
      border: 2px solid #e1e5e9;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 15px;
      background: white;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .idea-card:hover,
    .story-card:hover,
    .scene-card:hover {
      border-color: #667eea;
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
    }

    .idea-card.selected,
    .story-card.selected {
      border-color: #667eea;
      background: #f0f4ff;
    }

    .idea-card h4,
    .story-card h4,
    .scene-card h4 {
      margin-bottom: 10px;
      color: #333;
    }

    .idea-card p,
    .story-card p,
    .scene-card p {
      color: #666;
      line-height: 1.5;
      margin-bottom: 10px;
    }

    .character-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .character-tag {
      background: #667eea;
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .hook-section {
      margin-top: 15px;
      padding: 15px;
      background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
      border: 2px solid #ffc107;
      border-radius: 8px;
      position: relative;
      animation: hookGlow 2s ease-in-out infinite alternate;
    }

    .hook-section h5 {
      margin-bottom: 10px;
      color: #856404;
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .hook-info {
      font-size: 0.8rem;
      color: #856404;
      cursor: help;
      opacity: 0.7;
      transition: opacity 0.3s ease;
    }

    .hook-info:hover {
      opacity: 1;
    }

    .hook-text {
      background: white;
      border: 1px solid #ffc107;
      border-radius: 6px;
      padding: 12px;
      font-size: 0.95rem;
      line-height: 1.4;
      color: #333;
      font-style: italic;
      position: relative;
    }

    .hook-text::before {
      content: '"';
      font-size: 2rem;
      color: #ffc107;
      position: absolute;
      top: -5px;
      left: 5px;
      font-family: serif;
    }

    @keyframes hookGlow {
      from {
        box-shadow: 0 0 5px rgba(255, 193, 7, 0.3);
      }

      to {
        box-shadow: 0 0 15px rgba(255, 193, 7, 0.6);
      }
    }

    .prompt-section {
      margin-top: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .prompt-section h5 {
      margin-bottom: 10px;
      color: #333;
      font-size: 1rem;
    }

    .prompt-text {
      background: white;
      border: 1px solid #e1e5e9;
      border-radius: 6px;
      padding: 12px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      line-height: 1.4;
      color: #333;
      margin-bottom: 10px;
      white-space: pre-wrap;
    }

    .copy-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .copy-btn:hover {
      background: #218838;
    }

    .copy-btn.copied {
      background: #6c757d;
    }

    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .checkbox-wrapper input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #667eea;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: #e1e5e9;
      border-radius: 3px;
      overflow: hidden;
      margin: 20px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      width: 0%;
      transition: width 0.3s ease;
    }

    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      border: 1px solid #f5c6cb;
    }

    .success-message {
      background: #d4edda;
      color: #155724;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      border: 1px solid #c3e6cb;
    }

    .keyframe-section {
      margin-top: 10px;
      padding: 10px;
      background: #e3f2fd;
      border-left: 4px solid #1976d2;
      border-radius: 6px;
    }

    .keyframe-text {
      font-style: italic;
      color: #1976d2;
      font-size: 0.97rem;
      margin-top: 4px;
    }

    @media (max-width: 768px) {
      .container {
        margin: 10px;
        border-radius: 15px;
      }

      .header {
        padding: 20px;
      }

      .header h1 {
        font-size: 2rem;
      }

      .steps-container {
        padding: 20px;
      }

      .character-grid {
        grid-template-columns: 1fr;
      }

      .character-card {
        flex-direction: column;
        text-align: center;
        gap: 10px;
      }

      .character-image {
        width: 60px;
        height: 60px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üé≠ Story Flow Generator</h1>
      <p>T·∫°o c√¢u chuy·ªán AI t·ª´ √Ω t∆∞·ªüng ƒë·∫øn c·∫£nh quay</p>
    </div>

    <div class="steps-container">
      <!-- Step 1: Generate Ideas -->
      <div class="step active" id="step1">
        <div class="step-header" onclick="toggleStep(1)">
          <h3><span class="step-number">1</span> T·∫°o √ù T∆∞·ªüng</h3>
          <span>‚ñº</span>
        </div>
        <div class="step-content">
          <div class="form-group">
            <label for="topic">Ch·ªß ƒë·ªÅ:</label>
            <input type="text" id="topic" class="form-control" placeholder="Nh·∫≠p ch·ªß ƒë·ªÅ c√¢u chuy·ªán..."
              value="Bi·ªÉn, n√∫i l·ª≠a, s√≥ng th·∫ßn, ƒë·∫°i d∆∞∆°ng, h·∫£i s·∫£n, ƒë√°y bi·ªÉn, b∆°i, l∆∞·ªõt s√≥ng, thuy·ªÅn, vui v·∫ª, chi·∫øn tranh, qu√°i v·∫≠t">
          </div>

          <div class="form-group">
            <label>Th·ªùi l∆∞·ª£ng video (gi√¢y):</label>
            <input type="number" id="duration" class="form-control" value="30" min="10" max="120">
          </div>

          <div class="form-group">
            <label>Th·ªùi gian m·ªói c·∫£nh (gi√¢y):</label>
            <input type="number" id="sceneTime" class="form-control" value="5" min="3" max="10">
          </div>

          <div class="form-group">
            <label>S·ªë l∆∞·ª£ng √Ω t∆∞·ªüng c·∫ßn t·∫°o:</label>
            <input type="number" id="numberOfIdeas" class="form-control" value="5" min="1" max="20">
          </div>

          <div class="form-group">
            <label>Ch·ªçn nh√¢n v·∫≠t:</label>
            <div class="character-grid" id="characterGrid">
              <!-- Characters will be loaded here -->
            </div>
          </div>

          <button class="btn" onclick="generateIdeas()" id="generateIdeasBtn">
            <span>üé≠ T·∫°o √ù T∆∞·ªüng</span>
          </button>

          <div id="ideasResults" class="results-container"></div>
        </div>
      </div>

      <!-- Step 2: Generate Stories -->
      <div class="step" id="step2">
        <div class="step-header" onclick="toggleStep(2)">
          <h3><span class="step-number">2</span> T·∫°o C√¢u Chuy·ªán</h3>
          <span>‚ñº</span>
        </div>
        <div class="step-content">
          <div id="selectedIdeasContainer">
            <p>Vui l√≤ng ch·ªçn √Ω t∆∞·ªüng t·ª´ b∆∞·ªõc 1 tr∆∞·ªõc khi t·∫°o c√¢u chuy·ªán.</p>
          </div>
          <button class="btn" onclick="generateStories()" id="generateStoriesBtn" disabled>
            <span>üìñ T·∫°o C√¢u Chuy·ªán</span>
          </button>
          <div id="storiesResults" class="results-container"></div>
        </div>
      </div>

      <!-- Step 3: Generate Scenes -->
      <div class="step" id="step3">
        <div class="step-header" onclick="toggleStep(3)">
          <h3><span class="step-number">3</span> T·∫°o C·∫£nh Quay</h3>
          <span>‚ñº</span>
        </div>
        <div class="step-content">
          <div id="selectedStoriesContainer">
            <p>Vui l√≤ng ch·ªçn c√¢u chuy·ªán t·ª´ b∆∞·ªõc 2 tr∆∞·ªõc khi t·∫°o c·∫£nh quay.</p>
          </div>
          <button class="btn" onclick="generateScenes()" id="generateScenesBtn" disabled>
            <span>üé¨ T·∫°o C·∫£nh Quay</span>
          </button>
          <div id="scenesResults" class="results-container"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global state
    let characters = [];
    let selectedCharacters = [];
    let generatedIdeas = [];
    let selectedIdeas = [];
    let generatedStories = [];
    let selectedStories = [];
    let generatedScenes = [];

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function () {
      loadCharacters();
    });

    // Load characters from API
    async function loadCharacters() {
      try {
        const response = await fetch('/api/characters');
        if (!response.ok) {
          throw new Error('Failed to fetch characters');
        }
        const data = await response.json();
        characters = data.characters;
        renderCharacterGrid();
      } catch (error) {
        console.error('Error loading characters:', error);
        // Fallback characters
        characters = [
          { value: "a chubby anthropomorphic orange-yellow tabby cat, with distinct orange-brown stripes, soft white fur on its chest and belly, a perfectly round face, large expressive amber eyes, and small pointy ears. It has extremely fluffy and well-groomed fur, radiating a joyful, nurturing, and playful demeanor.", label: "Chubby Cat", image_link: "https://via.placeholder.com/80x80/ff6b35/ffffff?text=üê±" },
          { value: "a cute capybara with brown fur, round body, small ears, and friendly expression", label: "Capybara", image_link: "https://via.placeholder.com/80x80/8b4513/ffffff?text=ü¶´" },
          { value: "a majestic eagle soaring in the sky, with powerful wings, sharp eyes, and regal appearance", label: "Soaring Eagle", image_link: "https://via.placeholder.com/80x80/4169e1/ffffff?text=ü¶Ö" },
          { value: "a cuddly panda cub with black and white fur, round face, and adorable expression", label: "Cuddly Panda Cub", image_link: "https://via.placeholder.com/80x80/000000/ffffff?text=üêº" }
        ];
        renderCharacterGrid();
      }
    }

    // Render character selection grid
    function renderCharacterGrid() {
      const grid = document.getElementById('characterGrid');
      grid.innerHTML = characters.map(char => `
                <div class="character-card" onclick="toggleCharacter('${char.label}')" data-character="${char.label}">
                    <div class="character-image">
                        <img src="${char.image_link || 'https://via.placeholder.com/80x80/667eea/ffffff?text=?'}" 
                             alt="${char.label}" 
                             onload="this.classList.remove('loading')"
                             onerror="handleImageError(this, '${char.label}')"
                             class="loading">
                    </div>
                    <div class="character-info">
                        <h4>${char.label}</h4>
                        <p>${char.value.substring(0, 80)}...</p>
                    </div>
                </div>
            `).join('');
    }

    // Handle image loading errors
    function handleImageError(img, characterLabel) {
      img.src = `https://via.placeholder.com/80x80/667eea/ffffff?text=${encodeURIComponent(characterLabel.charAt(0))}`;
      img.classList.remove('loading');
      img.classList.add('error');
    }

    // Toggle character selection
    function toggleCharacter(characterLabel) {
      const card = document.querySelector(`[data-character="${characterLabel}"]`);
      const index = selectedCharacters.indexOf(characterLabel);

      if (index > -1) {
        selectedCharacters.splice(index, 1);
        card.classList.remove('selected');
      } else {
        selectedCharacters.push(characterLabel);
        card.classList.add('selected');
      }
    }

    // Toggle step visibility
    function toggleStep(stepNumber) {
      const step = document.getElementById(`step${stepNumber}`);
      step.classList.toggle('active');
    }

    // Generate ideas
    async function generateIdeas() {
      const topic = document.getElementById('topic').value;
      const duration = parseInt(document.getElementById('duration').value);
      const sceneTime = parseInt(document.getElementById('sceneTime').value);
      const numberOfIdeas = parseInt(document.getElementById('numberOfIdeas').value);

      if (!topic.trim()) {
        showError('Vui l√≤ng nh·∫≠p ch·ªß ƒë·ªÅ');
        return;
      }

      if (selectedCharacters.length === 0) {
        showError('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt nh√¢n v·∫≠t');
        return;
      }

      if (numberOfIdeas < 1 || numberOfIdeas > 20) {
        showError('S·ªë l∆∞·ª£ng √Ω t∆∞·ªüng ph·∫£i t·ª´ 1 ƒë·∫øn 20');
        return;
      }

      const btn = document.getElementById('generateIdeasBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> ƒêang t·∫°o √Ω t∆∞·ªüng...';

      try {
        const response = await fetch('/api/generate-ideas', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            topic,
            characters: selectedCharacters,
            numberOfIdeas,
            duration,
            sceneTime
          })
        });

        if (!response.ok) {
          throw new Error('Network response was not ok');
        }

        const data = await response.json();
        generatedIdeas = data.ideas;
        renderIdeas();
        showSuccess(`ƒê√£ t·∫°o th√†nh c√¥ng ${generatedIdeas.length} √Ω t∆∞·ªüng!`);

        // Enable next step
        document.getElementById('generateStoriesBtn').disabled = false;

      } catch (error) {
        console.error('Error:', error);
        showError('C√≥ l·ªói x·∫£y ra khi t·∫°o √Ω t∆∞·ªüng: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<span>üé≠ T·∫°o √ù T∆∞·ªüng</span>';
      }
    }

    // Render ideas
    function renderIdeas() {
      const container = document.getElementById('ideasResults');
      container.innerHTML = `
                <h4>√ù t∆∞·ªüng ƒë√£ t·∫°o (${generatedIdeas.length}):</h4>
                ${generatedIdeas.map((idea, index) => `
                    <div class="idea-card" onclick="toggleIdeaSelection(${index})" data-idea="${index}">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" ${selectedIdeas.includes(index) ? 'checked' : ''} onclick="event.stopPropagation()">
                            <h4>√ù t∆∞·ªüng ${index + 1}</h4>
                        </div>
                        <p><strong>√ù t∆∞·ªüng:</strong> ${idea.idea}</p>
                        <p><strong>C·∫£m x√∫c:</strong> ${idea.feelings}</p>
                        <p><strong>Phong c√°ch:</strong> ${idea.styles}</p>
                        <div class="character-tags">
                            ${idea.characters.map(char => `<span class="character-tag">${char}</span>`).join('')}
                        </div>
                    </div>
                `).join('')}
            `;
    }

    // Toggle idea selection
    function toggleIdeaSelection(index) {
      const checkbox = document.querySelector(`[data-idea="${index}"] input[type="checkbox"]`);
      checkbox.checked = !checkbox.checked;

      if (checkbox.checked) {
        if (!selectedIdeas.includes(index)) {
          selectedIdeas.push(index);
        }
      } else {
        const removeIndex = selectedIdeas.indexOf(index);
        if (removeIndex > -1) {
          selectedIdeas.splice(removeIndex, 1);
        }
      }

      updateSelectedIdeasContainer();
    }

    // Update selected ideas container
    function updateSelectedIdeasContainer() {
      const container = document.getElementById('selectedIdeasContainer');
      if (selectedIdeas.length === 0) {
        container.innerHTML = '<p>Vui l√≤ng ch·ªçn √Ω t∆∞·ªüng t·ª´ b∆∞·ªõc 1 tr∆∞·ªõc khi t·∫°o c√¢u chuy·ªán.</p>';
        document.getElementById('generateStoriesBtn').disabled = true;
      } else {
        container.innerHTML = `
                    <h4>√ù t∆∞·ªüng ƒë√£ ch·ªçn (${selectedIdeas.length}):</h4>
                    ${selectedIdeas.map(index => `
                        <div class="idea-card selected">
                            <h4>√ù t∆∞·ªüng ${index + 1}</h4>
                            <p>${generatedIdeas[index].idea}</p>
                        </div>
                    `).join('')}
                `;
        document.getElementById('generateStoriesBtn').disabled = false;
      }
    }

    // Generate stories
    async function generateStories() {
      if (selectedIdeas.length === 0) {
        showError('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt √Ω t∆∞·ªüng');
        return;
      }

      const btn = document.getElementById('generateStoriesBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> ƒêang t·∫°o c√¢u chuy·ªán...';

      try {
        const selectedIdeasData = selectedIdeas.map(index => generatedIdeas[index]);

        const response = await fetch('/api/generate-stories', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            ideas: selectedIdeasData,
            duration: parseInt(document.getElementById('duration').value)
          })
        });

        if (!response.ok) {
          throw new Error('Network response was not ok');
        }

        const data = await response.json();
        generatedStories = data.stories;
        renderStories();
        showSuccess(`ƒê√£ t·∫°o th√†nh c√¥ng ${generatedStories.length} c√¢u chuy·ªán!`);

        // Enable next step
        document.getElementById('generateScenesBtn').disabled = false;

      } catch (error) {
        console.error('Error:', error);
        showError('C√≥ l·ªói x·∫£y ra khi t·∫°o c√¢u chuy·ªán: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<span>üìñ T·∫°o C√¢u Chuy·ªán</span>';
      }
    }

    // Render stories
    function renderStories() {
      const container = document.getElementById('storiesResults');
      container.innerHTML = `
                <h4>C√¢u chuy·ªán ƒë√£ t·∫°o (${generatedStories.length}):</h4>
                ${generatedStories.map((story, index) => `
                    <div class="story-card" onclick="toggleStorySelection(${index})" data-story="${index}">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" ${selectedStories.includes(index) ? 'checked' : ''} onclick="event.stopPropagation()">
                            <h4>${story.title}</h4>
                        </div>
                        <p><strong>M√¥ t·∫£:</strong> ${story.description}</p>
                        <p><strong>S·ªë c·∫£nh:</strong> ${story.scenes.length}</p>
                        ${story.hook ? `
                            <div class="hook-section">
                                <h5>üé£ Hook (C·∫£nh 1): <span class="hook-info" title="Hook l√† y·∫øu t·ªë thu h√∫t s·ª± ch√∫ √Ω ngay t·ª´ ƒë·∫ßu video, gi√∫p ng∆∞·ªùi xem mu·ªën ti·∫øp t·ª•c xem">‚ìò</span></h5>
                                <div class="hook-text">${story.hook}</div>
                            </div>
                        ` : ''}
                        <div class="character-tags">
                            ${story.hashtags.slice(0, 3).map(tag => `<span class="character-tag">${tag}</span>`).join('')}
                        </div>
                    </div>
                `).join('')}
            `;
    }

    // Toggle story selection
    function toggleStorySelection(index) {
      const checkbox = document.querySelector(`[data-story="${index}"] input[type="checkbox"]`);
      checkbox.checked = !checkbox.checked;

      if (checkbox.checked) {
        if (!selectedStories.includes(index)) {
          selectedStories.push(index);
        }
      } else {
        const removeIndex = selectedStories.indexOf(index);
        if (removeIndex > -1) {
          selectedStories.splice(removeIndex, 1);
        }
      }

      updateSelectedStoriesContainer();
    }

    // Update selected stories container
    function updateSelectedStoriesContainer() {
      const container = document.getElementById('selectedStoriesContainer');
      if (selectedStories.length === 0) {
        container.innerHTML = '<p>Vui l√≤ng ch·ªçn c√¢u chuy·ªán t·ª´ b∆∞·ªõc 2 tr∆∞·ªõc khi t·∫°o c·∫£nh quay.</p>';
        document.getElementById('generateScenesBtn').disabled = true;
      } else {
        container.innerHTML = `
                    <h4>C√¢u chuy·ªán ƒë√£ ch·ªçn (${selectedStories.length}):</h4>
                    ${selectedStories.map(index => {
          const story = generatedStories[index];
          return `
                            <div class="story-card selected">
                                <h4>${story.title}</h4>
                                <p>${story.description}</p>
                                ${story.hook ? `
                                    <div class="hook-section">
                                        <h5>üé£ Hook (C·∫£nh 1): <span class="hook-info" title="Hook l√† y·∫øu t·ªë thu h√∫t s·ª± ch√∫ √Ω ngay t·ª´ ƒë·∫ßu video, gi√∫p ng∆∞·ªùi xem mu·ªën ti·∫øp t·ª•c xem">‚ìò</span></h5>
                                        <div class="hook-text">${story.hook}</div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
        }).join('')}
                `;
        document.getElementById('generateScenesBtn').disabled = false;
      }
    }

    // Generate scenes
    async function generateScenes() {
      if (selectedStories.length === 0) {
        showError('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt c√¢u chuy·ªán');
        return;
      }

      const btn = document.getElementById('generateScenesBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> ƒêang t·∫°o c·∫£nh quay...';

      try {
        const selectedStoriesData = selectedStories.map(index => generatedStories[index]);

        const response = await fetch('/api/generate-scenes', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            stories: selectedStoriesData
          })
        });

        if (!response.ok) {
          throw new Error('Network response was not ok');
        }

        const data = await response.json();
        generatedScenes = data.scenes;
        renderScenes();
        showSuccess(`ƒê√£ t·∫°o th√†nh c√¥ng c·∫£nh quay cho ${generatedScenes.length} c√¢u chuy·ªán!`);

      } catch (error) {
        console.error('Error:', error);
        showError('C√≥ l·ªói x·∫£y ra khi t·∫°o c·∫£nh quay: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<span>üé¨ T·∫°o C·∫£nh Quay</span>';
      }
    }

    // Render scenes
    function renderScenes() {
      const container = document.getElementById('scenesResults');
      container.innerHTML = `
                <h4>C·∫£nh quay ƒë√£ t·∫°o:</h4>
                ${generatedScenes.map((storyScenes, storyIndex) => `
                    <div class="story-card">
                        <h4>${storyScenes.storyTitle}</h4>
                        ${storyScenes.scenes.map((scene, sceneIndex) => `
                            <div class="scene-card">
                                <h5>C·∫£nh ${scene.scene_number}: ${scene.description}</h5>
                                <p><strong>Nh√¢n v·∫≠t:</strong> ${scene.characters.join(', ')}</p>
                                <p><strong>B·ªëi c·∫£nh:</strong> ${scene.setting}</p>
                                <p><strong>H√†nh ƒë·ªông:</strong> ${scene.action}</p>
                                ${scene.scene_number === 1 && storyScenes.storyHook ? `
                                    <div class="hook-section">
                                        <h5>üé£ Hook: <span class="hook-info" title="Hook l√† y·∫øu t·ªë thu h√∫t s·ª± ch√∫ √Ω ngay t·ª´ ƒë·∫ßu video, gi√∫p ng∆∞·ªùi xem mu·ªën ti·∫øp t·ª•c xem">‚ìò</span></h5>
                                        <div class="hook-text">${storyScenes.storyHook}</div>
                                    </div>
                                ` : ''}
                                
                                <div class="prompt-section">
                                    <h5>Image Prompt:</h5>
                                    <div class="prompt-text">${scene.scene.image_prompt}</div>
                                    <button class="copy-btn" onclick="copyToClipboard('${scene.scene.image_prompt.replace(/'/g, "\\'")}')">
                                        üìã Copy Image Prompt
                                    </button>
                                </div>
                                
                                <div class="prompt-section">
                                    <h5>Video Prompt:</h5>
                                    <div class="prompt-text">${scene.scene.video_prompt}</div>
                                    <button class="copy-btn" onclick="copyToClipboard('${scene.scene.video_prompt.replace(/'/g, "\\'")}')">
                                        üìã Copy Video Prompt
                                    </button>
                                </div>
                                ${scene.scene.master_key_frame ? `
                                    <div class="keyframe-section">
                                        <h5>üé¨ Master Key Frame:</h5>
                                        <div class="keyframe-text">${scene.scene.master_key_frame}</div>
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `).join('')}
            `;
    }

    // Copy to clipboard function
    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = '‚úÖ Copied!';
        btn.classList.add('copied');

        setTimeout(() => {
          btn.textContent = originalText;
          btn.classList.remove('copied');
        }, 2000);
      } catch (err) {
        console.error('Failed to copy: ', err);
        showError('Kh√¥ng th·ªÉ copy v√†o clipboard');
      }
    }

    // Show error message
    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.textContent = message;

      const container = document.querySelector('.steps-container');
      container.insertBefore(errorDiv, container.firstChild);

      setTimeout(() => {
        errorDiv.remove();
      }, 5000);
    }

    // Show success message
    function showSuccess(message) {
      const successDiv = document.createElement('div');
      successDiv.className = 'success-message';
      successDiv.textContent = message;

      const container = document.querySelector('.steps-container');
      container.insertBefore(successDiv, container.firstChild);

      setTimeout(() => {
        successDiv.remove();
      }, 5000);
    }
  </script>
</body>

</html>